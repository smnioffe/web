<!DOCTYPE html>
<meta charset="utf-8">

<head>
 <link href="css/jquery-ui.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/jquery-ui.structure.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/jquery-ui.theme.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href='//fonts.googleapis.com/css?family=Roboto' type="text/css" rel="stylesheet" media="all" />
    <link href='//fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700' type="text/css" rel="stylesheet" media="all" />
    <link href='//fonts.googleapis.com/css?family=Roboto:400,900italic,700italic,900,700,500italic,500,400italic,300italic,300,100italic,100' type="text/css" rel="stylesheet" media="all" />
    <link href='//fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' type="text/css" rel="stylesheet" media="all" />
    <link href='//fonts.googleapis.com/css?family=Maven+Pro:400,500,700,900' type="text/css" rel="stylesheet" media="all" />
    <link href='//fonts.googleapis.com/css?family=RobotoDraft:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en' rel='stylesheet' type='text/css'>
    <style>
	
	        body {
            font-family: 'Roboto', sans-serif;
            font: 10px sans-serif;
            background-color: #e0e0e0;


}

        svg .textLabel {
            font-size: 12px;
        }
        
        .containerMP {
            margin-top: 5%;
            margin-left: 10%;
            margin-right: 10%;
        }
		
form{
margin-top:7.5px;
font-family: 'Roboto', sans-serif;
}
    </style>
   
</head>

<body>





    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/materialize.min.js"></script>
    <script src="js/d3.min.js"></script>

    <script>
        // $(document).ready(function() {

            // $('.collapsible').collapsible({
                // accordion: false // A setting that changes the collapsible behavior to expandable instead of the default accordion style
            // });
			  
        // });
		


	
		

		
    </script>


	 <div class="row">
	 <div><div>
	 					
    <div class="containerMP col s8  offset-s2">
        <ul class="collapsible" data-collapsible="expandable">
		
		
		
		
		<li>
<div class="collapsible-header grey lighten-3">
<div class="col s2 offset-s8" style="font-size:12px;font-family:Roboto Slab;text-align:right;">
Filter By Client:
</div>	
<div class="col s2"> 
 
<form action="#">
 

   
    <select name="clientDropDown" id="clientDropDown">
      <option selected="selected">All</option>
    </select>
 
    
 
</form>
 
</div>

</div>
</li>
		
		            <li >
                <div id="PRDMPheader"  class="collapsible-header active grey lighten-3" style="font-size:18px;font-family:Roboto Slab;">PROD</div>
                <div  class="collapsible-body grey lighten-3">
                    <div class="row">
                        <div class="col s11 offset-s1"   id="PRDMP"> </div>
                        <div class="col s1" id="PRDCLI"> </div>
                        <div class="col s11" id="PRDCLILine"> </div>
                    </div>
                </div>
            </li>
			            <li>
                <div id="UATMPheader" class="collapsible-header  grey lighten-3" style="font-size:18px;font-family:Roboto Slab;">UAT</div>
                <div class="collapsible-body grey lighten-3">
                    <div class="row">
                        <div class="col s11 offset-s1" id="UATMP"> </div>
                        <div class="col s1" id="UATCLI"> </div>
                        <div class="col s11" id="UATCLILine"> </div>
                    </div>
                </div>
            </li>
			
			         <li>
                <div id="QAMPheader" class="collapsible-header  grey lighten-3" style="font-size:18px;font-family:Roboto Slab;">QA</div>
                <div class="collapsible-body grey lighten-3">
                    <div class="row">
                        <div class="col s11 offset-s1" id="QAMP"> </div>
                        <div class="col s1" id="QACLI"> </div>
                        <div class="col s11" id="QACLILine"> </div>
                    </div>
                </div>
            </li>
			
            <li >

                <div id="DEVMPheader" class="collapsible-header  grey lighten-3" style="font-size:18px;font-family:Roboto Slab;">DEV</div>


                <div   class="collapsible-body  grey lighten-3">
                    <div class="row">
                        <div class="col s11 offset-s1" id="DEVMP"> </div>
                        <div class="col s1" id="DEVCLI"> </div>
                        <div class="col s11" id="DEVCLILine"> </div>
                    </div>
                </div>
            </li>


   


        </ul>
    </div>
	 <div class="row">
	 

    <script>
        var materializeColors = {
            teal: "#009688",
            pink: "#e91e63",
            orange: "#ff9800",
            blue: "#2196f3",
            dblue: "#2B3856",
            lblue: "#B7F6F6",
            yellow: "#FBB917",
            yellow2: "#FBB917",
            lyellow: "#FFFF80",
            purple: "#9c27b0",
            platinum: "#E5E4E2",
            bluegrey: "#98AFC7",
            red: "#C11B17",
            red2: "#F32900",
            lred: "#E77471",
            dred: "#800517",
            lgreen: "#04FB75",
            green: "#007A00",
            white: "#FFFFFF",
            dgrey: "#595959",
            lgrey: "#D9D9D9"
        };
		

	
		
		
		
		

        var margin = {
                top: 10,
                right: 20,
                bottom: 0,
                left: 20
            },
            width = 600 - margin.left - margin.right,
            height = 80 - margin.top - margin.bottom;


        var allMeasures = [];
        var allPeriods = [];

        d3.csv("measure_period.csv", function(error, data) {
            data.forEach(function(d) {
                d.database_name = d.database_name;
                d.measures = d.measures;
                d.CLIENT = d.CLIENT;
                d.ENV = d.ENV;
                d.periods = d.periods;
                d.periods_count = d.periods_count;
                if (d.database_name == "all") {
                    allMeasures.push(d.measures);
                    allPeriods.push(d.periods);
                };

                if (d.measures !== undefined) {
                    d.subMeasures = d.measures.split(/;/);
                } else(d.subMeasures = "none")

                if (d.periods !== undefined) {
                    d.subPeriods = d.periods.split(/;/);
                } else(d.subPeriods = "none")

                if (d.periods_count !== undefined) {
                    d.subPeriods_count = d.periods_count.split(/;/);
                } else(d.subPeriods_count = "none")

            });

            allMeasures = allMeasures.toString().split(";");
            allMeasures.sort(d3.ascending);

           

            allPeriods = allPeriods.toString().split(";");
			
			combinedTitle = allMeasures.concat("");

            combinedTitle = combinedTitle.concat(allPeriods);
			
           

		   var  distinctClients = d3.set(
                data
				.filter(function(d) { //console.log(d.ENV); console.log(envVar)
                    return d.CLIENT !== ""
                })
                .map(function(d) {
                    return d.CLIENT;
                })).values();


distinctClients.forEach(function(d) {				
					 $(function() {
 $("#clientDropDown").append('<option value="'+d+'">'+d+'</option>');
    $( "#clientDropDown" ).selectmenu();
 
  });	
     });	

 $(function() {

     $( "#clientDropDown" ).selectmenu({
         change: function( event, ui ) {
             //console.log(ui);
             var selected_value = ui.item.value;
			 filterByClient(selected_value);

         }
     });
});	 
	 

function envLoop(envVar,client){
            //Find Distinct Clients
            distinctClients = d3.set(
                data.filter(function(d) { //console.log(d.ENV); console.log(envVar)
				if (client=='All'){return d.ENV == envVar}else{return d.ENV == envVar && d.CLIENT==client}
                    
                })
                .map(function(d) {
                    return d.CLIENT;
                })).values();
				

	
				

        var svg = d3.select("#"+envVar+"MP").append("svg").attr("class","measurePeriodChart")
            .attr("width", "99%")
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");


            //Client Label
            var clientLabel = d3.select("#"+envVar+"CLI")
                .append("svg:svg").attr("class","measurePeriodChart")
                .attr("width", "100%")
                .attr("height", function(d) {
                    return distinctClients.length * 40 + "px";
                })

            clientLabel.selectAll(".textLabel")
                .data(distinctClients)
                .enter().append("text")
                .attr("text-anchor", "left")
                .attr("textAlign", "left")
				//.attr("font-size", "12px")
                .attr("x", "20")
                .attr("y", function(d) {
                    return distinctClients.indexOf(d) * 40 + 30 + "px";
                })
                .text(function(d) {
                    return d
                })
                .attr("class", "textLabel");

            //Define the main body
            var clientBody = d3.select("#"+envVar+"CLILine")
                .append("svg:svg").attr("class","measurePeriodChart")
                .attr("width", "99%")
                .attr("height", function(d) {
                    return distinctClients.length * 40 + 30 + "px";
                });

            clientBody.selectAll(".clientLine")
                .data(distinctClients)
                .enter().append("svg:line")
                .attr("class", 'd3-dp-line')
                .attr("x1", 0)
                .attr("y1", function(d) {
                    return distinctClients.indexOf(d) * 40 + 20 + "px";
                })
                .attr("x2", "90%")
                .attr("y2", function(d) {
                    return distinctClients.indexOf(d) * 40 + 20 + "px";
                })
                //.style("stroke-dasharray", ("3, 3"))
                // .style("stroke-opacity", 0.8)
                .style("stroke", materializeColors.dgrey)
                .attr("stroke-width", ".5")
                .attr("class", "clientLine");
				
				
			            // clientBody.selectAll(".clientLine2")
                // .data(combinedTitle)
                // .enter().append("svg:line")
                // .attr("class", 'd3-dp-line')
                // .attr("y1", 0)
				// .attr("x1", function(d, i) {return i * 30 + "px";})
                // .attr("y2", "99%")
                // .attr("x2", function(d, i) {return i * 30 + "px";})
                // .style("stroke", materializeColors.dgrey)
                // .attr("stroke-width", ".5")
                // .attr("class", "clientLine2");	


            clientsFil = data.filter(function(d) {
                return d.ENV == envVar;
            });

            clientsFil.sort(d3.ascending)



            clientsFil.forEach(function(a, i) {


                var Client = d3.set(
                    clientsFil.map(function(d) {
                        return d.CLIENT[i];
                    })).values();

                //console.log(a.CLIENT)


                var Measures = d3.set(
                    clientsFil.map(function(d) { //console.log(d.CLIENT[i]);
                        return d.subMeasures[i];
                    })).values();



                //All measures that are run
                clientBody.selectAll(".clientBox")
                    .data(clientsFil)
                    .enter().append("rect")
                    .attr("class", "tile")

                .attr("x", function(d, i) {

                        return allMeasures.indexOf(a.subMeasures[i]) * 30 + "px";
                    })
                    .attr("y", function(d) {
                        return distinctClients.indexOf(a.CLIENT) * 40 + 20 + "px";
                    })
                    .attr("width", "20px")
                    .attr("height", "20px")
                    .style("opacity", .9)
                    .style("fill", materializeColors.green);


                //All measures that are NOT run
                var measuresNotRun = allMeasures.filter(function(el) {
                    return a.subMeasures.indexOf(el) < 0;
                });



                clientBody.selectAll(".clientBox")
                    .data(measuresNotRun)
                    .enter().append("rect")
                    .attr("class", "tile")
                    .attr("x", function(d, i) {
                        return allMeasures.indexOf(measuresNotRun[i]) * 30 + "px";
                    })
                    .attr("y", function(d) {
                        return distinctClients.indexOf(a.CLIENT) * 40 + 20 + "px";
                    })
                    .attr("width", "20px")
                    .attr("height", "20px")
                    .style("opacity", 1)
                    .style("fill", materializeColors.lgrey);




                //All periods that are run
                clientBody.selectAll(".clientBox")
                    .data(clientsFil)
                    .enter().append("rect")
                    .attr("class", "tile")

                .attr("x", function(d, i) {

                        return combinedTitle.indexOf(a.subPeriods[i]) * 30 + "px";
                    })
                    .attr("y", function(d) {
                        return distinctClients.indexOf(a.CLIENT) * 40 + 20 + "px";
                    })
                    .attr("width", "20px")
                    .attr("height", "20px")
                    .style("opacity", .9)
                    .style("fill",function(d,i) {
					if (-a.subPeriods_count[i]*-1>15){return materializeColors.red2}
					if (-a.subPeriods_count[i]*-1>8){return materializeColors.yellow2}
					else{return materializeColors.dblue}
					});
					
					
					
                //Count for all periods that are run
                clientBody.selectAll(".clientBox")
                    .data(clientsFil)
                    .enter().append("text")


                .attr("x", function(d, i) {
				z=a.subPeriods_count[i];
						if ( z!==undefined)

						{return combinedTitle.indexOf(a.subPeriods[i]) * 30 +12-z.length*2.75+ "px";}
                    })
                    .attr("y", function(d) {
                        return distinctClients.indexOf(a.CLIENT) * 40 + 33 + "px";
                    })
					.attr("fill","white")
					//.attr("font-weight","bold")
					.attr("font-size","12.5px")
					                  .attr("text-anchor", "center")
                .attr("textAlign", "center")
					.text(function(d,i) {
                        return a.subPeriods_count[i]
                    });
 			
				
				
				
				
				
				//All periods that are NOT run
                var periodsNotRun = allPeriods.filter(function(el) {
                    return a.subPeriods.indexOf(el) < 0;
                });
				
				

                clientBody.selectAll(".clientBox")
                    .data(periodsNotRun )
                    .enter().append("rect")
                    .attr("class", "tile")
                    .attr("x", function(d, i) {
                        return combinedTitle.indexOf(periodsNotRun[i]) * 30 + "px";
                    })
                    .attr("y", function(d) {
                        return distinctClients.indexOf(a.CLIENT) * 40 + 20 + "px";
                    })
                    .attr("width", "20px")
                    .attr("height", "20px")
                    .style("opacity", 1)
                    .style("fill", materializeColors.lgrey);	


            })




            Title = svg.selectAll(".textLabel")
                .data(combinedTitle)
                .enter().append("text")

            .attr("text-anchor", "left")
                .attr("textAlign", "center")
                .text(function(d) {
                    return d
                })
                .attr("class", "textLabel")
                .attr("transform", function(d) {
                    k = combinedTitle.indexOf(d) * 30 - 15;
                    return "translate(" + k + ",10) rotate(90)"
                });

				
		
$("#"+envVar+"MPheader").removeClass("active");				
				
if((distinctClients.length>0 && client!=='All'))
 {

 $("#"+envVar+"MPheader").addClass("active");
//document.getElementById(envVar+"MPheader").className = 'collapsible-header active grey lighten-3';

}
//else
//{

//document.getElementById(envVar+"MPheader").className = 'collapsible-header grey lighten-3';




//}

            








};

function populateEnviornments(client){


envLoop("DEV",client)
envLoop("QA",client)
envLoop("UAT",client)
envLoop("PRD",client)


			
			
}

populateEnviornments('All')

function filterByClient(client)		
{
$(".measurePeriodChart").remove();
populateEnviornments(client)

    $('.collapsible').collapsible({
      accordion : false // A setting that changes the collapsible behavior to expandable instead of the default accordion style
    });
}



        });
		

    </script>




</body>